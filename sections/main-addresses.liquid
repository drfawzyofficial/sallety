{%- comment -%}
  Main Addresses Section
  Simplified design using color_scheme
  RTL layout - Address Management
{%- endcomment -%}

{%- liquid
  # Color scheme class (uses CSS classes from theme.liquid)
  assign scheme_number = section.settings.color_scheme.id | remove: 'scheme-'

  # Layout Settings
  assign card_radius = section.settings.card_radius | default: 16
-%}

{%- capture section_dir -%}{%- render 'section-dir' -%}{%- endcapture -%}
<section
  class="main-addresses color-scheme-{{ scheme_number }} py-8 lg:py-12"
  dir="{{ section_dir }}"
  style="
    --addresses-card-radius: {{ card_radius }}px;
    min-height: 100vh;
  "
>
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl">
    <!-- Header -->
    <div class="addresses-header mb-8">
      <div class="flex items-center gap-4 mb-4">
        <a
          href="{{ routes.account_url }}"
          class="addresses-back p-2 rounded-lg transition-colors"
          style="color: var(--color-secondary-text);"
        >
          <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m9 18 6-6-6-6"/>
          </svg>
        </a>
        <h1 class="addresses-title" style="color: var(--color-accent);">
          {{ section.settings.page_title | default: 'العناوين' }}
        </h1>
      </div>
      <p style="color: var(--color-secondary-text);">
        {{ section.settings.page_subtitle | default: 'إدارة عناوين الشحن والتوصيل' }}
      </p>
    </div>

    <!-- Add New Address Button -->
    <button
      type="button"
      onclick="toggleAddressForm('new')"
      class="addresses-add-btn w-full flex items-center justify-center gap-3 p-4 mb-8 transition-all"
      style="
        border: 2px dashed var(--color-border);
        border-radius: var(--addresses-card-radius);
        color: var(--color-secondary-text);
        background: transparent;
      "
    >
      <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="16"/>
        <line x1="8" y1="12" x2="16" y2="12"/>
      </svg>
      {{ section.settings.add_btn_text | default: 'إضافة عنوان جديد' }}
    </button>

    <!-- New Address Form -->
    <div
      id="newAddressForm"
      class="addresses-form-card mb-8"
      style="display: none; background: var(--color-card-background); border-radius: var(--addresses-card-radius); box-shadow: 0 4px 16px rgba(0,0,0,0.08);"
    >
      <div class="p-6 lg:p-8">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-semibold" style="color: var(--color-accent);">
            {{ 'customer.addresses.add_new' | t }}
          </h2>
          <button
            type="button"
            onclick="toggleAddressForm('new')"
            class="p-2 rounded-lg transition-colors"
            style="color: var(--color-secondary-text);"
          >
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
          </button>
        </div>

        {%- form 'customer_address', customer.new_address, class: 'addresses-form' -%}
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
            <!-- First Name -->
            <div class="addresses-field">
              <label for="AddressFirstName" class="block mb-2 font-medium" style="color: var(--color-text);">
                {{- 'customer.addresses.first_name' | t -}}
              </label>
              <input
                type="text"
                id="AddressFirstName"
                name="address[first_name]"
                class="addresses-input w-full"
                autocomplete="given-name"
                required
                style="height: 48px;"
              >
            </div>

            <!-- Last Name -->
            <div class="addresses-field">
              <label for="AddressLastName" class="block mb-2 font-medium" style="color: var(--color-text);">
                {{- 'customer.addresses.last_name' | t -}}
              </label>
              <input
                type="text"
                id="AddressLastName"
                name="address[last_name]"
                class="addresses-input w-full"
                autocomplete="family-name"
                required
                style="height: 48px;"
              >
            </div>

            <!-- Company -->
            <div class="addresses-field sm:col-span-2">
              <label for="AddressCompany" class="block mb-2 font-medium" style="color: var(--color-text);">
                {{- 'customer.addresses.company' | t }} (اختياري)</label
              >
              <input
                type="text"
                id="AddressCompany"
                name="address[company]"
                class="addresses-input w-full"
                autocomplete="organization"
                style="height: 48px;"
              >
            </div>

            <!-- Address 1 -->
            <div class="addresses-field sm:col-span-2">
              <label for="AddressAddress1" class="block mb-2 font-medium" style="color: var(--color-text);">
                {{- 'customer.addresses.address1' | t -}}
              </label>
              <input
                type="text"
                id="AddressAddress1"
                name="address[address1]"
                class="addresses-input w-full"
                autocomplete="address-line1"
                required
                style="height: 48px;"
              >
            </div>

            <!-- City -->
            <div class="addresses-field">
              <label for="AddressCity" class="block mb-2 font-medium" style="color: var(--color-text);">
                {{- 'customer.addresses.city' | t -}}
              </label>
              <input
                type="text"
                id="AddressCity"
                name="address[city]"
                class="addresses-input w-full"
                autocomplete="address-level2"
                required
                style="height: 48px;"
              >
            </div>

            <!-- Country -->
            <div class="addresses-field">
              <label for="AddressCountry" class="block mb-2 font-medium" style="color: var(--color-text);">
                {{- 'customer.addresses.country' | t -}}
              </label>
              <select
                id="AddressCountry"
                name="address[country]"
                class="addresses-input w-full"
                data-default="{{ form.country }}"
                autocomplete="country"
                style="height: 48px;"
              >
                {{ all_country_option_tags }}
              </select>
            </div>

            <!-- Province -->
            <div class="addresses-field" id="AddressProvinceContainer">
              <label for="AddressProvince" class="block mb-2 font-medium" style="color: var(--color-text);">
                {{- 'customer.addresses.province' | t -}}
              </label>
              <select
                id="AddressProvince"
                name="address[province]"
                class="addresses-input w-full"
                data-default="{{ form.province }}"
                autocomplete="address-level1"
                style="height: 48px;"
              ></select>
            </div>

            <!-- Zip -->
            <div class="addresses-field">
              <label for="AddressZip" class="block mb-2 font-medium" style="color: var(--color-text);">
                {{- 'customer.addresses.zip' | t -}}
              </label>
              <input
                type="text"
                id="AddressZip"
                name="address[zip]"
                class="addresses-input w-full"
                autocomplete="postal-code"
                style="height: 48px;"
              >
            </div>

            <!-- Phone -->
            <div class="addresses-field sm:col-span-2">
              <label for="AddressPhone" class="block mb-2 font-medium" style="color: var(--color-text);">
                {{- 'customer.addresses.phone' | t -}}
              </label>
              <input
                type="tel"
                id="AddressPhone"
                name="address[phone]"
                class="addresses-input w-full"
                autocomplete="tel"
                style="height: 48px; direction: ltr; text-align: right;"
              >
            </div>

            <!-- Default Address -->
            <div class="addresses-field sm:col-span-2">
              <label class="flex items-center gap-3 cursor-pointer">
                <input
                  type="checkbox"
                  name="address[default]"
                  value="1"
                  class="w-5 h-5 rounded"
                  style="accent-color: var(--color-button);"
                >
                <span style="color: var(--color-text);">{{ 'customer.addresses.set_default' | t }}</span>
              </label>
            </div>
          </div>

          <div class="flex items-center gap-4 mt-8">
            <button
              type="submit"
              class="addresses-submit-btn btn btn--primary flex-1"
              style="height: 52px; border: none;"
            >
              {{ 'customer.addresses.add' | t }}
            </button>
            <button
              type="button"
              onclick="toggleAddressForm('new')"
              class="addresses-cancel-btn btn btn--secondary px-6"
              style="height: 52px; color: var(--color-secondary-text); background: transparent; border: 2px solid var(--color-border);"
            >
              {{ 'customer.addresses.cancel' | t }}
            </button>
          </div>
        {%- endform -%}
      </div>
    </div>

    <!-- Existing Addresses -->
    {%- if customer.addresses.size > 0 -%}
      <div class="addresses-list grid grid-cols-1 md:grid-cols-2 gap-6">
        {%- for address in customer.addresses -%}
          <div
            class="addresses-card p-6"
            style="background: var(--color-card-background); border-radius: var(--addresses-card-radius); box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid var(--color-border);"
          >
            {%- if address == customer.default_address -%}
              <div
                class="addresses-badge inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium mb-4"
                style="background: color-mix(in srgb, var(--color-success) 10%, transparent); color: var(--color-success);"
              >
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                {{ 'customer.addresses.default' | t }}
              </div>
            {%- endif -%}

            <div class="addresses-content mb-4" style="color: var(--color-text); line-height: 1.7;">
              <p class="font-semibold" style="color: var(--color-accent);">
                {{ address.first_name }}
                {{ address.last_name }}
              </p>
              {%- if address.company != blank -%}
                <p>{{ address.company }}</p>
              {%- endif -%}
              <p>{{ address.address1 }}</p>
              {%- if address.address2 != blank -%}
                <p>{{ address.address2 }}</p>
              {%- endif -%}
              <p>
                {{ address.city }}, {{ address.province_code }}
                {{ address.zip }}
              </p>
              <p>{{ address.country }}</p>
              {%- if address.phone != blank -%}
                <p dir="ltr" class="text-right">{{ address.phone }}</p>
              {%- endif -%}
            </div>

            <div
              class="addresses-actions flex items-center gap-3 pt-4"
              style="border-top: 1px solid var(--color-border);"
            >
              <button
                type="button"
                onclick="toggleEditForm('{{ address.id }}')"
                class="flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg transition-colors"
                style="color: var(--color-button); background: color-mix(in srgb, var(--color-button) 10%, transparent);"
              >
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                {{ 'customer.addresses.edit' | t }}
              </button>
              <button
                type="button"
                onclick="deleteAddress('{{ address.url }}', '{{ address.id }}')"
                class="flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg transition-colors"
                style="color: var(--color-error); background: color-mix(in srgb, var(--color-error) 10%, transparent);"
              >
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                {{ 'customer.addresses.delete' | t }}
              </button>
            </div>

            <!-- Edit Form (Hidden) -->
            <div
              id="editForm_{{ address.id }}"
              class="addresses-edit-form mt-6 pt-6"
              style="display: none; border-top: 1px solid var(--color-border);"
            >
              {%- form 'customer_address', address, class: 'addresses-form' -%}
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div class="addresses-field">
                    <label class="block mb-2 text-sm font-medium" style="color: var(--color-text);">
                      {{- 'customer.addresses.first_name' | t -}}
                    </label>
                    <input
                      type="text"
                      name="address[first_name]"
                      value="{{ address.first_name }}"
                      class="addresses-input w-full"
                      required
                      style="height: 44px;"
                    >
                  </div>
                  <div class="addresses-field">
                    <label class="block mb-2 text-sm font-medium" style="color: var(--color-text);">
                      {{- 'customer.addresses.last_name' | t -}}
                    </label>
                    <input
                      type="text"
                      name="address[last_name]"
                      value="{{ address.last_name }}"
                      class="addresses-input w-full"
                      required
                      style="height: 44px;"
                    >
                  </div>
                  <div class="addresses-field sm:col-span-2">
                    <label class="block mb-2 text-sm font-medium" style="color: var(--color-text);">
                      {{- 'customer.addresses.address1' | t -}}
                    </label>
                    <input
                      type="text"
                      name="address[address1]"
                      value="{{ address.address1 }}"
                      class="addresses-input w-full"
                      required
                      style="height: 44px;"
                    >
                  </div>
                  <div class="addresses-field">
                    <label class="block mb-2 text-sm font-medium" style="color: var(--color-text);">
                      {{- 'customer.addresses.city' | t -}}
                    </label>
                    <input
                      type="text"
                      name="address[city]"
                      value="{{ address.city }}"
                      class="addresses-input w-full"
                      required
                      style="height: 44px;"
                    >
                  </div>
                  <div class="addresses-field">
                    <label class="block mb-2 text-sm font-medium" style="color: var(--color-text);">
                      {{- 'customer.addresses.phone' | t -}}
                    </label>
                    <input
                      type="tel"
                      name="address[phone]"
                      value="{{ address.phone }}"
                      class="addresses-input w-full"
                      style="height: 44px; direction: ltr; text-align: right;"
                    >
                  </div>
                  <div class="addresses-field sm:col-span-2">
                    <label class="flex items-center gap-3 cursor-pointer">
                      <input
                        type="checkbox"
                        name="address[default]"
                        value="1"
                        {% if address == customer.default_address %}
                          checked
                        {% endif %}
                        class="w-5 h-5 rounded"
                        style="accent-color: var(--color-button);"
                      >
                      <span class="text-sm" style="color: var(--color-text);">
                        {{- 'customer.addresses.set_default' | t -}}
                      </span>
                    </label>
                  </div>
                </div>
                <div class="flex items-center gap-3 mt-6">
                  <button
                    type="submit"
                    class="btn btn--primary flex-1 py-3"
                  >
                    {{ 'customer.addresses.update' | t }}
                  </button>
                  <button
                    type="button"
                    onclick="toggleEditForm('{{ address.id }}')"
                    class="btn btn--secondary px-4 py-3"
                    style="color: var(--color-secondary-text); border: 1px solid var(--color-border);"
                  >
                    {{ 'customer.addresses.cancel' | t }}
                  </button>
                </div>
              {%- endform -%}
            </div>
          </div>
        {%- endfor -%}
      </div>
    {%- else -%}
      <div class="addresses-empty text-center py-16">
        <div
          class="w-20 h-20 mx-auto mb-6 rounded-full flex items-center justify-center"
          style="background: color-mix(in srgb, var(--color-secondary-text) 10%, transparent);"
        >
          <svg
            class="w-10 h-10"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            style="color: var(--color-secondary-text);"
          >
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
        </div>
        <h3 class="text-lg font-semibold mb-2" style="color: var(--color-accent);">
          {{ section.settings.empty_title | default: 'لا توجد عناوين محفوظة' }}
        </h3>
        <p style="color: var(--color-secondary-text);">
          {{ section.settings.empty_text | default: 'أضف عنوانك الأول لتسهيل عملية الشحن' }}
        </p>
      </div>
    {%- endif -%}
  </div>
</section>

<style>
  .main-addresses .addresses-back:hover {
    background: color-mix(in srgb, var(--color-button) 10%, transparent);
    color: var(--color-button);
  }

  .main-addresses .addresses-add-btn:hover {
    border-color: var(--color-button);
    color: var(--color-button);
    background: color-mix(in srgb, var(--color-button) 5%, transparent);
  }

  .main-addresses .addresses-input:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-accent) 10%, transparent);
  }

  .main-addresses .addresses-submit-btn:hover {
    filter: brightness(1.1);
    transform: translateY(-1px);
  }

  .main-addresses .addresses-cancel-btn:hover {
    border-color: var(--color-button);
    color: var(--color-button);
  }

  @media (prefers-reduced-motion: reduce) {
    .main-addresses * {
      transition: none !important;
    }
  }
</style>

<script>
  /**
   * Address Management - Customer addresses functionality
   * @fileoverview Handles address form interactions and deletion
   * @version 2.0.0
   */
  (function () {
    'use strict';

    /** @constant {string} New address form ID */
    const NEW_FORM_ID = 'newAddressForm';
    /** @constant {string} Edit form prefix */
    const EDIT_FORM_PREFIX = 'editForm_';
    /** @constant {string} Delete confirmation message */
    const DELETE_CONFIRM_MESSAGE = '{{ "customer.addresses.delete_confirm" | t }}';

    /**
     * Toggle the new address form visibility
     * @param {string} type - The form type identifier
     * @returns {void}
     */
    window.toggleAddressForm = function (type) {
      const form = document.getElementById(NEW_FORM_ID);
      if (!form) {
        console.warn('[Addresses] New address form not found');
        return;
      }

      const isHidden = form.style.display === 'none' || !form.style.display;

      if (isHidden) {
        form.style.display = 'block';
        // Smooth scroll with reduced motion support
        const scrollBehavior = prefersReducedMotion() ? 'auto' : 'smooth';
        form.scrollIntoView({ behavior: scrollBehavior, block: 'start' });
        // Focus first input for accessibility
        const firstInput = form.querySelector('input:not([type="hidden"])');
        firstInput?.focus();
      } else {
        form.style.display = 'none';
      }
    };

    /**
     * Toggle an edit form visibility
     * @param {string} id - The address ID
     * @returns {void}
     */
    window.toggleEditForm = function (id) {
      if (!id) {
        console.warn('[Addresses] No address ID provided');
        return;
      }

      const form = document.getElementById(EDIT_FORM_PREFIX + id);
      if (!form) {
        console.warn(`[Addresses] Edit form not found for ID: ${id}`);
        return;
      }

      const isHidden = form.style.display === 'none' || !form.style.display;
      form.style.display = isHidden ? 'block' : 'none';

      // Focus first input when opening
      if (isHidden) {
        const firstInput = form.querySelector('input:not([type="hidden"])');
        firstInput?.focus();
      }
    };

    /**
     * Delete an address with confirmation
     * @param {string} url - The delete action URL
     * @param {string} id - The address ID
     * @returns {void}
     */
    window.deleteAddress = function (url, id) {
      if (!url) {
        console.error('[Addresses] No URL provided for deletion');
        return;
      }

      if (!confirm(DELETE_CONFIRM_MESSAGE)) {
        return;
      }

      // Create and submit deletion form
      const form = document.createElement('form');
      form.method = 'post';
      form.action = url;
      form.style.display = 'none';

      const methodInput = document.createElement('input');
      methodInput.type = 'hidden';
      methodInput.name = '_method';
      methodInput.value = 'delete';
      form.appendChild(methodInput);

      document.body.appendChild(form);
      form.submit();
    };

    /**
     * Check if user prefers reduced motion
     * @returns {boolean} True if reduced motion is preferred
     */
    function prefersReducedMotion() {
      return window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    }

    /**
     * Initialize country/province selectors
     * @returns {void}
     */
    function initCountryProvinceSelectors() {
      if (typeof Shopify === 'undefined' || !Shopify.CountryProvinceSelector) {
        return;
      }

      try {
        new Shopify.CountryProvinceSelector('AddressCountry', 'AddressProvince', {
          hideElement: 'AddressProvinceContainer',
        });
      } catch (error) {
        console.warn('[Addresses] Country selector initialization failed:', error.message);
      }
    }

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCountryProvinceSelectors);
    } else {
      initCountryProvinceSelectors();
    }
  })();
</script>

{% schema %}
{
  "name": "t:sections.main_addresses.name",
  "tag": "section",
  "class": "section-main-addresses",
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.main_addresses.settings.color_scheme.label",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:sections.main_addresses.settings.header.content"
    },
    {
      "type": "text",
      "id": "page_title",
      "label": "t:sections.main_addresses.settings.page_title.label",
      "default": "العناوين"
    },
    {
      "type": "text",
      "id": "page_subtitle",
      "label": "t:sections.main_addresses.settings.page_subtitle.label",
      "default": "إدارة عناوين الشحن والتوصيل"
    },
    {
      "type": "text",
      "id": "add_btn_text",
      "label": "t:sections.main_addresses.settings.add_btn_text.label",
      "default": "إضافة عنوان جديد"
    },
    {
      "type": "header",
      "content": "t:sections.main_addresses.settings.header.content"
    },
    {
      "type": "text",
      "id": "empty_title",
      "label": "t:sections.main_addresses.settings.empty_title.label",
      "default": "لا توجد عناوين محفوظة"
    },
    {
      "type": "text",
      "id": "empty_text",
      "label": "t:sections.main_addresses.settings.empty_text.label",
      "default": "أضف عنوانك الأول لتسهيل عملية الشحن"
    },
    {
      "type": "header",
      "content": "t:sections.main_addresses.settings.header.content"
    },
    {
      "type": "range",
      "id": "card_radius",
      "label": "t:sections.main_addresses.settings.card_radius.label",
      "default": 16,
      "min": 0,
      "max": 32,
      "step": 2,
      "unit": "px"
    }
  ]
}
{% endschema %}
