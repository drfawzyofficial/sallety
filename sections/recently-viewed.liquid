{%- comment -%}
  Sallety Theme - Premium Recently Viewed Products Section
  High-quality, responsive recently viewed products with RTL/LTR support.

  Features:
  - Fully responsive (Desktop, Tablet, Mobile)
  - RTL/LTR support based on locale
  - LocalStorage for tracking viewed products
  - Smooth scroll carousel on mobile
  - Grid layout on desktop
  - Uses the shared product-card snippet
  - Loading skeleton
  - Empty state with call to action
  - Auto-hide when no products viewed
{%- endcomment -%}

{%- liquid
  # Section settings
  assign heading = section.settings.heading
  assign subheading = section.settings.subheading
  assign products_to_show = section.settings.products_to_show | default: 4
  assign columns_desktop = section.settings.columns_desktop | default: 4
  assign columns_tablet = section.settings.columns_tablet | default: 3
  assign columns_mobile = section.settings.columns_mobile | default: 2
  assign show_view_all = section.settings.show_view_all
  assign layout_style = section.settings.layout_style | default: 'grid'
  assign card_style = section.settings.card_style | default: 'default'
  assign show_vendor = section.settings.show_vendor
  assign show_rating = section.settings.show_rating
  assign image_ratio = section.settings.image_ratio | default: 'portrait'
  assign hide_when_empty = section.settings.hide_when_empty | default: true
  assign exclude_current_product = section.settings.exclude_current_product | default: true

  # Color scheme
  assign color_scheme = section.settings.color_scheme | default: 'scheme-1'
  assign scheme_number = color_scheme | remove: 'scheme-'

  # Grid columns classes
  case columns_desktop
    when 2
      assign desktop_cols = 'lg:grid-cols-2'
    when 3
      assign desktop_cols = 'lg:grid-cols-3'
    when 5
      assign desktop_cols = 'lg:grid-cols-5'
    when 6
      assign desktop_cols = 'lg:grid-cols-6'
    else
      assign desktop_cols = 'lg:grid-cols-4'
  endcase

  case columns_tablet
    when 2
      assign tablet_cols = 'md:grid-cols-2'
    when 4
      assign tablet_cols = 'md:grid-cols-4'
    else
      assign tablet_cols = 'md:grid-cols-3'
  endcase

  case columns_mobile
    when 1
      assign mobile_cols = 'grid-cols-1'
    else
      assign mobile_cols = 'grid-cols-2'
  endcase
-%}

{%- liquid
  assign text_direction = 'rtl'
  assign rtl_languages = 'ar,he,fa,ur,ku,ps,sd,yi' | split: ','
  assign current_lang = request.locale.iso_code | downcase | slice: 0, 2
  if rtl_languages contains current_lang
    assign text_direction = 'rtl'
  elsif settings.enable_rtl
    assign text_direction = 'rtl'
  else
    assign text_direction = 'ltr'
  endif
-%}

<section
  class="recently-viewed section color-scheme-{{ scheme_number }}"
  data-section-id="{{ section.id }}"
  data-section-type="recently-viewed"
  data-products-to-show="{{ products_to_show }}"
  data-exclude-current="{{ exclude_current_product }}"
  data-current-product-id="{{ product.id }}"
  data-hide-when-empty="{{ hide_when_empty }}"
  data-image-ratio="{{ image_ratio }}"
  data-show-vendor="{{ show_vendor }}"
  dir="{{ text_direction }}"
  style="
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
    {% if hide_when_empty %}display: none;{% endif %}
  "
>
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
    {%- comment -%} Section Header {%- endcomment -%}
    <header class="recently-viewed__header mb-8 md:mb-10 lg:mb-12">
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4">
        <div class="text-center sm:text-start">
          {%- if heading != blank -%}
            <h2 class="recently-viewed__title text-2xl sm:text-3xl lg:text-4xl font-bold text-foreground mb-2 leading-tight">
              {{ heading }}
            </h2>
          {%- endif -%}
          {%- if subheading != blank -%}
            <p class="recently-viewed__subtitle text-sm sm:text-base text-secondary max-w-xl">
              {{ subheading }}
            </p>
          {%- endif -%}
        </div>

        {%- if show_view_all -%}
          <a
            href="{{ routes.all_products_collection_url }}"
            class="recently-viewed__view-all inline-flex items-center justify-center sm:justify-start gap-2 text-sm font-semibold text-primary hover:text-primary/80 transition-colors group"
          >
            <span>{{ 'sections.recently_viewed.view_all' | t | default: 'تصفح المنتجات' }}</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="rv-view-all-arrow transition-transform group-hover:-translate-x-1"
            >
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </a>
        {%- endif -%}
      </div>

      {%- comment -%} Decorative line {%- endcomment -%}
      <div class="mt-6 flex items-center gap-4">
        <div class="h-1 w-16 sm:w-24 bg-gradient-to-l from-accent to-accent/50 rounded-full"></div>
        <div class="flex-1 h-px bg-border/50"></div>
      </div>
    </header>

    {%- comment -%} Products Container {%- endcomment -%}
    {%- if layout_style == 'carousel' -%}
      {%- comment -%} Carousel Layout {%- endcomment -%}
      <div class="recently-viewed__carousel relative">
        <div
          class="recently-viewed__carousel-track flex gap-4 sm:gap-5 lg:gap-6 overflow-x-auto pb-4 -mx-4 px-4 sm:-mx-6 sm:px-6 lg:mx-0 lg:px-0 snap-x snap-mandatory scrollbar-hide"
          data-recently-viewed-products
          data-layout="carousel"
        >
          {%- comment -%} Products will be loaded via JavaScript {%- endcomment -%}
        </div>

        {%- comment -%} Carousel Navigation (Desktop) {%- endcomment -%}
        <button
          type="button"
          class="recently-viewed__nav recently-viewed__nav--prev hidden lg:flex absolute top-1/2 -translate-y-1/2 -start-4 xl:-start-6 w-12 h-12 items-center justify-center rounded-full bg-background border border-border shadow-lg text-foreground hover:bg-accent hover:text-white hover:border-accent transition-all duration-200 z-10 disabled:opacity-50 disabled:cursor-not-allowed"
          data-carousel-prev
          aria-label="{{ 'accessibility.previous' | t | default: 'السابق' }}"
          style="display: none;"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="rv-nav-arrow-icon"
          >
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <button
          type="button"
          class="recently-viewed__nav recently-viewed__nav--next hidden lg:flex absolute top-1/2 -translate-y-1/2 -end-4 xl:-end-6 w-12 h-12 items-center justify-center rounded-full bg-background border border-border shadow-lg text-foreground hover:bg-accent hover:text-white hover:border-accent transition-all duration-200 z-10 disabled:opacity-50 disabled:cursor-not-allowed"
          data-carousel-next
          aria-label="{{ 'accessibility.next' | t | default: 'التالي' }}"
          style="display: none;"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="rv-nav-arrow-icon"
          >
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>

        {%- comment -%} Carousel Dots (Mobile/Tablet) {%- endcomment -%}
        <div
          class="recently-viewed__dots flex lg:hidden items-center justify-center gap-2 mt-6"
          data-carousel-dots
          style="display: none;"
        >
          {%- comment -%} Dots will be generated via JavaScript {%- endcomment -%}
        </div>
      </div>

    {%- else -%}
      {%- comment -%} Grid Layout {%- endcomment -%}
      <div
        class="recently-viewed__grid grid {{ mobile_cols }} {{ tablet_cols }} {{ desktop_cols }} gap-4 sm:gap-5 lg:gap-6"
        data-recently-viewed-products
        data-layout="grid"
      >
        {%- comment -%} Products will be loaded via JavaScript {%- endcomment -%}
      </div>
    {%- endif -%}

    {%- comment -%} Loading Skeleton {%- endcomment -%}
    <div
      class="recently-viewed__loading grid {{ mobile_cols }} {{ tablet_cols }} {{ desktop_cols }} gap-4 sm:gap-5 lg:gap-6"
      data-recently-viewed-loading
      style="display: none;"
    >
      {%- for i in (1..products_to_show) -%}
        <div class="recently-viewed__skeleton animate-pulse">
          <div class="aspect-[3/4] rounded-xl bg-border/40 mb-3"></div>
          <div class="h-3 bg-border/40 rounded w-1/3 mb-2"></div>
          <div class="h-4 bg-border/40 rounded w-3/4 mb-2"></div>
          <div class="h-4 bg-border/40 rounded w-1/2"></div>
        </div>
      {%- endfor -%}
    </div>

    {%- comment -%} Empty State {%- endcomment -%}
    <div class="recently-viewed__empty hidden text-center py-12" data-recently-viewed-empty>
      <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-border/30 flex items-center justify-center">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="40"
          height="40"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="text-secondary"
        >
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-foreground mb-2">
        {{ 'sections.recently_viewed.empty_title' | t | default: 'لم تشاهد أي منتجات بعد' }}
      </h3>
      <p class="text-sm text-secondary mb-6 max-w-md mx-auto">
        {{
          'sections.recently_viewed.empty_description'
          | t
          | default: 'تصفح منتجاتنا وستظهر هنا المنتجات التي شاهدتها مؤخراً'
        }}
      </p>
      <a
        href="{{ routes.all_products_collection_url }}"
        class="inline-flex items-center gap-2 px-6 py-3 rounded-xl bg-accent text-white font-semibold hover:bg-accent/90 transition-all duration-200 shadow-lg shadow-accent/25"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <path d="M16 10a4 4 0 0 1-8 0"></path>
        </svg>
        {{ 'sections.recently_viewed.browse_products' | t | default: 'تصفح المنتجات' }}
      </a>
    </div>
  </div>
</section>

<style>
  /* Recently Viewed Section Styles */
  .recently-viewed {
    /* Direction is set via dir attribute on the section element */
  }

  /* Fade in up animation */
  @keyframes rv-fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .rv-animate-fade-in-up {
    animation: rv-fadeInUp 0.5s ease-out forwards;
    opacity: 0;
  }

  /* Carousel scrollbar hide */
  .recently-viewed .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .recently-viewed .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  /* Carousel smooth scroll */
  .recently-viewed__carousel-track {
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
  }

  /* Snap scroll */
  .recently-viewed .snap-x {
    scroll-snap-type: x mandatory;
  }

  .recently-viewed .snap-start {
    scroll-snap-align: start;
  }

  /* Navigation buttons hover effect */
  .recently-viewed__nav {
    backdrop-filter: blur(8px);
  }

  /* Loading skeleton pulse */
  @keyframes rv-pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  .recently-viewed .animate-pulse {
    animation: rv-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  /* Carousel dots active state */
  .recently-viewed__dots button.is-active {
    background-color: var(--color-accent);
    width: 1.5rem;
  }

  /* RTL specific adjustments */
  [dir='rtl'] .recently-viewed__carousel-track {
    direction: rtl;
  }

  [dir='rtl'] .recently-viewed__nav--prev {
    right: auto;
    left: -1rem;
  }

  [dir='rtl'] .recently-viewed__nav--next {
    left: auto;
    right: -1rem;
  }

  @media (min-width: 1280px) {
    [dir='rtl'] .recently-viewed__nav--prev {
      left: -1.5rem;
    }
    [dir='rtl'] .recently-viewed__nav--next {
      right: -1.5rem;
    }
  }

  /* RTL Arrow Icons Flip */
  [dir='rtl'] .rv-nav-arrow-icon {
    transform: scaleX(-1);
  }

  /* RTL View All Arrow */
  [dir='rtl'] .rv-view-all-arrow {
    transform: scaleX(-1);
  }

  [dir='rtl'] a:hover .rv-view-all-arrow {
    transform: scaleX(-1) translateX(4px);
  }

  /* LTR adjustments - arrows are already correct for LTR */
  [dir='ltr'] .recently-viewed__nav--prev {
    left: -1rem;
    right: auto;
  }

  [dir='ltr'] .recently-viewed__nav--next {
    right: -1rem;
    left: auto;
  }

  @media (min-width: 1280px) {
    [dir='ltr'] .recently-viewed__nav--prev {
      left: -1.5rem;
    }
    [dir='ltr'] .recently-viewed__nav--next {
      right: -1.5rem;
    }
  }

  /* Responsive font sizes */
  @media (max-width: 639px) {
    .recently-viewed__title {
      font-size: 1.5rem;
    }
    .recently-viewed__subtitle {
      font-size: 0.875rem;
    }
  }

  @media (min-width: 640px) and (max-width: 1023px) {
    .recently-viewed__title {
      font-size: 1.875rem;
    }
  }

  /* Grid gap responsive */
  @media (max-width: 639px) {
    .recently-viewed__grid {
      gap: 0.75rem;
    }
  }

  /* Hover states for touch devices */
  @media (hover: none) {
    .recently-viewed__nav {
      display: none !important;
    }
  }

  /* Focus visible states */
  .recently-viewed a:focus-visible,
  .recently-viewed button:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  /* Carousel item width for carousel layout */
  .recently-viewed__carousel-track .recently-viewed__item {
    flex-shrink: 0;
    width: calc(50% - 0.5rem);
  }

  @media (min-width: 640px) {
    .recently-viewed__carousel-track .recently-viewed__item {
      width: calc(33.333% - 0.833rem);
    }
  }

  @media (min-width: 1024px) {
    .recently-viewed__carousel-track .recently-viewed__item {
      width: calc(25% - 1.125rem);
    }
  }

  /* Reduced Motion */
  @media (prefers-reduced-motion: reduce) {
    .rv-animate-fade-in-up {
      animation: none;
      opacity: 1;
    }
  }
</style>

<script>
  // Recently Viewed Products Module
  (function() {
    const STORAGE_KEY = 'sallety_recently_viewed';
    const MAX_PRODUCTS = 20;
    
    const section = document.querySelector('[data-section-id="{{ section.id }}"]');
    if (!section) return;
    
    const container = section.querySelector('[data-recently-viewed-products]');
    const loadingEl = section.querySelector('[data-recently-viewed-loading]');
    const emptyEl = section.querySelector('[data-recently-viewed-empty]');
    const prevBtn = section.querySelector('[data-carousel-prev]');
    const nextBtn = section.querySelector('[data-carousel-next]');
    const dotsContainer = section.querySelector('[data-carousel-dots]');
    
    const productsToShow = parseInt(section.dataset.productsToShow) || 4;
    const excludeCurrent = section.dataset.excludeCurrent === 'true';
    const currentProductId = section.dataset.currentProductId;
    const hideWhenEmpty = section.dataset.hideWhenEmpty === 'true';
    const layout = container?.dataset.layout || 'grid';
    const imageRatio = section.dataset.imageRatio || 'portrait';
    const showVendor = section.dataset.showVendor === 'true';
    
    // Product card HTML cache
    const cardCache = {};
    
    // Get recently viewed product handles from localStorage
    function getRecentlyViewed() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        return stored ? JSON.parse(stored) : [];
      } catch (e) {
        console.error('[Sallety] Error reading recently viewed:', e);
        return [];
      }
    }
    
    // Save product to recently viewed
    function saveToRecentlyViewed(handle) {
      try {
        let products = getRecentlyViewed();
        
        // Remove if already exists
        products = products.filter(p => p !== handle);
        
        // Add to beginning
        products.unshift(handle);
        
        // Limit to max products
        products = products.slice(0, MAX_PRODUCTS);
        
        localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
      } catch (e) {
        console.error('[Sallety] Error saving recently viewed:', e);
      }
    }
    
    // Fetch product card HTML using the server-rendered product.card.liquid template
    async function fetchProductCardHTML(handle) {
      // Check cache first
      if (cardCache[handle]) return cardCache[handle];
      
      try {
        // Fetch the product page with alternate view=card to get just the product-card snippet
        const response = await fetch(`/products/${handle}?view=card`);
        if (!response.ok) {
          // Fallback: fetch the product JSON and build card from that
          return await fetchProductCardFallback(handle);
        }
        const html = await response.text();
        
        // Try to extract product-card from the response
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const productCard = doc.querySelector('[data-product-card]');
        
        if (productCard) {
          // Check if we need to exclude the current product
          const cardProductId = productCard.getAttribute('data-product-id');
          if (excludeCurrent && cardProductId === currentProductId) {
            cardCache[handle] = '__SKIP__';
            return '__SKIP__';
          }
          
          const wrapper = document.createElement('div');
          wrapper.appendChild(productCard.cloneNode(true));
          cardCache[handle] = wrapper.innerHTML;
          return cardCache[handle];
        }
        
        // If no product-card found, fallback
        return await fetchProductCardFallback(handle);
      } catch (e) {
        console.error(`[Sallety] Error fetching product card for ${handle}:`, e);
        return await fetchProductCardFallback(handle);
      }
    }
    
    // Fallback: fetch product JSON and build minimal card
    async function fetchProductCardFallback(handle) {
      try {
        const response = await fetch(`/products/${handle}.js`);
        if (!response.ok) return null;
        const product = await response.json();
        
        if (!product) return null;

        // Check if this is the current product we want to exclude
        if (excludeCurrent && product.id.toString() === currentProductId) {
          return '__SKIP__';
        }
        
        const variant = product.variants[0];
        const hasDiscount = variant.compare_at_price && variant.compare_at_price > variant.price;
        const onSale = hasDiscount;
        
        // Format money
        function formatMoney(cents) {
          const amount = (cents / 100).toFixed(2);
          if (window.Shopify && window.Shopify.currency && window.Shopify.currency.active) {
            return `${amount} ${window.Shopify.currency.active}`;
          }
          return `${amount} {{ shop.currency }}`;
        }
        
        // Get image aspect ratio
        let ratioStyle = 'aspect-ratio: 3 / 4;';
        switch(imageRatio) {
          case 'portrait': ratioStyle = 'aspect-ratio: 2 / 3;'; break;
          case 'square': ratioStyle = 'aspect-ratio: 1 / 1;'; break;
          case 'landscape': ratioStyle = 'aspect-ratio: 4 / 3;'; break;
        }
        
        const imgSrc = product.featured_image ? product.featured_image.replace(/(\.[^.]+)$/, '_720x$1') : '';
        
        // Build a product card matching the product-card.liquid structure
        let cardHTML = `
          <div class="product-card group relative flex flex-col bg-[var(--color-background)] overflow-hidden" data-product-card data-product-id="${product.id}">
            <div class="product-card__media relative overflow-hidden rounded-2xl bg-[#f5f5f7]">
              <a href="/products/${product.handle}" class="product-card__image-link block relative overflow-hidden product-card__image-link--no-swap" tabindex="-1" aria-hidden="true" style="${ratioStyle}">
                ${imgSrc ? `<img src="${imgSrc}" alt="${product.title}" width="720" height="960" loading="lazy" class="product-card__img product-card__img--primary absolute inset-0 w-full h-full object-cover transition-all duration-500 ease-out z-[1] group-hover:scale-105">` : `<div class="product-card__placeholder flex items-center justify-center w-full h-full bg-[#f5f5f7]"></div>`}
              </a>
              <div class="product-card__actions absolute top-3 start-3 z-[6] flex flex-col gap-2">
                ${('{{ settings.enable_wishlist }}' === 'true') ? `
                <button type="button" class="product-card__action-btn product-card__wishlist-btn w-10 h-10 flex items-center justify-center rounded-full bg-white text-[var(--color-foreground)] shadow-md border border-black/5 transition-all duration-200 ease-out hover:scale-110 active:scale-95" data-wishlist-add="${product.id}" data-product-handle="${product.handle}" data-product-title="${product.title}" data-product-image="${product.featured_image || ''}" data-product-price="${variant.price}" data-product-url="/products/${product.handle}" aria-label="{{ 'products.product.add_to_wishlist' | t | default: 'أضف للمفضلة' }}" title="{{ 'products.product.add_to_wishlist' | t | default: 'أضف للمفضلة' }}">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none flex-shrink-0 wishlist-icon"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                </button>` : ''}
                ${('{{ settings.enable_quick_view }}' === 'true') ? `
                <button type="button" class="product-card__action-btn product-card__quickview-btn w-10 h-10 flex items-center justify-center rounded-full bg-[var(--color-primary,#1a2744)] text-white shadow-md transition-all duration-200 ease-out hover:scale-110 active:scale-95" data-quick-view="${product.handle}" aria-label="{{ 'products.product.quick_view' | t | default: 'عرض سريع' }}" title="{{ 'products.product.quick_view' | t | default: 'عرض سريع' }}">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none flex-shrink-0"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>` : ''}
              </div>
            </div>
            <div class="product-card__info flex flex-col items-center py-4 px-2 text-center">
              <h3 class="product-card__title text-[0.95rem] font-semibold leading-snug mb-1">
                <a href="/products/${product.handle}" class="text-[var(--color-foreground)] no-underline line-clamp-2 hover:text-[var(--color-primary)] transition-colors">${product.title}</a>
              </h3>
              ${showVendor && product.vendor ? `<p class="product-card__vendor text-[0.8rem] text-[var(--color-secondary-text,#6b7280)] mb-2">${product.vendor}</p>` : ''}
              <div class="product-card__price flex items-center justify-center gap-2 flex-wrap mb-3">
                ${onSale ? `
                  <span class="product-card__price-sale text-[1.1rem] font-bold text-[var(--color-error,#dc2626)]">${formatMoney(variant.price)}</span>
                  <span class="product-card__price-compare text-[0.85rem] text-[var(--color-secondary-text,#9ca3af)] line-through">${formatMoney(variant.compare_at_price)}</span>
                ` : `
                  <span class="product-card__price-regular text-[1.1rem] font-bold text-[var(--color-foreground)]">${formatMoney(variant.price)}</span>
                `}
              </div>
              <div class="product-card__atc-wrapper w-full">
                ${product.available ? `
                  <a href="/products/${product.handle}" class="product-card__atc-btn flex items-center justify-center gap-2 w-full py-3 px-4 rounded-lg bg-[var(--color-primary,#1a2744)] text-white font-semibold text-sm transition-all duration-200 hover:opacity-90 hover:shadow-lg active:scale-[0.98]">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 pointer-events-none"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="8" x2="16" y2="16"/><line x1="8" y1="8" x2="8" y2="16"/><line x1="12" y1="11" x2="12" y2="16"/></svg>
                    <span>{{ 'products.product.add_to_cart' | t | default: 'إضافة للسلة' }}</span>
                  </a>
                ` : `
                  <button type="button" class="product-card__atc-btn flex items-center justify-center gap-2 w-full py-3 px-4 rounded-lg bg-[var(--color-secondary-text,#9ca3af)] text-white font-semibold text-sm cursor-not-allowed opacity-70" disabled>
                    <span>{{ 'products.product.sold_out' | t | default: 'نفذت الكمية' }}</span>
                  </button>
                `}
              </div>
            </div>
          </div>
        `;
        
        cardCache[handle] = cardHTML;
        return cardHTML;
      } catch (e) {
        console.error(`[Sallety] Error in fallback for ${handle}:`, e);
        return null;
      }
    }
    
    // Initialize carousel navigation
    function initCarousel() {
      if (layout !== 'carousel' || !container) return;
      
      const items = container.querySelectorAll('.recently-viewed__item');
      if (items.length === 0) return;
      
      let currentIndex = 0;
      
      function getVisibleCount() {
        if (window.innerWidth >= 1024) return {{ columns_desktop }};
        if (window.innerWidth >= 640) return {{ columns_tablet }};
        return {{ columns_mobile }};
      }
      
      function updateNavState() {
        const visibleCount = getVisibleCount();
        const maxIndex = Math.max(0, items.length - visibleCount);
        
        if (prevBtn) {
          prevBtn.disabled = currentIndex <= 0;
          prevBtn.style.display = items.length > visibleCount ? '' : 'none';
        }
        if (nextBtn) {
          nextBtn.disabled = currentIndex >= maxIndex;
          nextBtn.style.display = items.length > visibleCount ? '' : 'none';
        }
      }
      
      function scrollToIndex(index) {
        const visibleCount = getVisibleCount();
        const maxIndex = Math.max(0, items.length - visibleCount);
        currentIndex = Math.max(0, Math.min(index, maxIndex));
        
        const item = items[currentIndex];
        if (item) {
          container.scrollTo({
            left: item.offsetLeft - container.offsetLeft,
            behavior: 'smooth'
          });
        }
        
        updateNavState();
      }
      
      if (prevBtn) {
        prevBtn.addEventListener('click', () => scrollToIndex(currentIndex - 1));
      }
      
      if (nextBtn) {
        nextBtn.addEventListener('click', () => scrollToIndex(currentIndex + 1));
      }
      
      container.addEventListener('scroll', () => {
        const scrollLeft = container.scrollLeft;
        const itemWidth = items[0]?.offsetWidth || 0;
        const gap = 16;
        currentIndex = Math.round(scrollLeft / (itemWidth + gap));
        updateNavState();
      });
      
      window.addEventListener('resize', updateNavState);
      updateNavState();
    }
    
    // Load and render products
    async function loadProducts() {
      const handles = getRecentlyViewed();
      
      if (handles.length === 0) {
        if (hideWhenEmpty) {
          section.style.display = 'none';
        } else {
          if (loadingEl) loadingEl.style.display = 'none';
          if (emptyEl) emptyEl.classList.remove('hidden');
        }
        return;
      }
      
      // Show loading
      if (loadingEl) loadingEl.style.display = '';
      section.style.display = '';
      
      // Fetch product cards - try server-rendered card first, fallback to JS-built card
      const cardHTMLs = [];
      for (const handle of handles.slice(0, productsToShow + 2)) {
        const cardHTML = await fetchProductCardHTML(handle);
        if (cardHTML && cardHTML !== '__SKIP__') {
          cardHTMLs.push(cardHTML);
          if (cardHTMLs.length >= productsToShow) break;
        }
      }
      
      // Hide loading
      if (loadingEl) loadingEl.style.display = 'none';
      
      if (cardHTMLs.length === 0) {
        if (hideWhenEmpty) {
          section.style.display = 'none';
        } else {
          if (emptyEl) emptyEl.classList.remove('hidden');
        }
        return;
      }
      
      // Render products
      if (container) {
        container.innerHTML = '';
        cardHTMLs.forEach((html, index) => {
          const wrapper = document.createElement('div');
          wrapper.className = `recently-viewed__item rv-animate-fade-in-up ${layout === 'carousel' ? 'snap-start' : ''}`;
          wrapper.style.animationDelay = `${index * 75}ms`;
          wrapper.innerHTML = html;
          container.appendChild(wrapper);
        });
      }
      
      // Initialize carousel if needed
      initCarousel();
    }
    
    // Track current product view
    function trackCurrentProduct() {
      const pathParts = window.location.pathname.split('/');
      const productIndex = pathParts.indexOf('products');
      if (productIndex !== -1 && pathParts[productIndex + 1]) {
        const handle = pathParts[productIndex + 1].split('?')[0];
        if (handle) {
          saveToRecentlyViewed(handle);
        }
      }
    }
    
    // Initialize
    trackCurrentProduct();
    loadProducts();
  })();
</script>

{% schema %}
{
  "name": "t:sections.recently_viewed.name",
  "tag": "section",
  "class": "section-recently-viewed",
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:sections.recently_viewed.settings.header_content.content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "t:sections.recently_viewed.settings.heading.label",
      "default": "شاهدته مؤخراً"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "t:sections.recently_viewed.settings.subheading.label",
      "default": "المنتجات التي قمت بتصفحها مؤخراً"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "t:sections.recently_viewed.settings.products_to_show.label",
      "default": 4,
      "min": 2,
      "max": 12,
      "step": 1
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "label": "t:sections.recently_viewed.settings.show_view_all.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "hide_when_empty",
      "label": "t:sections.recently_viewed.settings.hide_when_empty.label",
      "info": "t:sections.recently_viewed.settings.hide_when_empty.info",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "exclude_current_product",
      "label": "t:sections.recently_viewed.settings.exclude_current_product.label",
      "info": "t:sections.recently_viewed.settings.exclude_current_product.info",
      "default": true
    },
    {
      "type": "header",
      "content": "t:sections.recently_viewed.settings.header_layout.content"
    },
    {
      "type": "select",
      "id": "layout_style",
      "label": "t:sections.recently_viewed.settings.layout_style.label",
      "options": [
        { "value": "grid", "label": "t:sections.recently_viewed.settings.layout_style.options.grid" },
        { "value": "carousel", "label": "t:sections.recently_viewed.settings.layout_style.options.carousel" }
      ],
      "default": "grid"
    },
    {
      "type": "select",
      "id": "columns_desktop",
      "label": "t:sections.recently_viewed.settings.columns_desktop.label",
      "options": [
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" },
        { "value": "4", "label": "4" },
        { "value": "5", "label": "5" },
        { "value": "6", "label": "6" }
      ],
      "default": "4"
    },
    {
      "type": "select",
      "id": "columns_tablet",
      "label": "t:sections.recently_viewed.settings.columns_tablet.label",
      "options": [
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" },
        { "value": "4", "label": "4" }
      ],
      "default": "3"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "label": "t:sections.recently_viewed.settings.columns_mobile.label",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" }
      ],
      "default": "2"
    },
    {
      "type": "header",
      "content": "t:sections.recently_viewed.settings.header_card.content"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "label": "t:sections.recently_viewed.settings.image_ratio.label",
      "options": [
        { "value": "adapt", "label": "t:sections.recently_viewed.settings.image_ratio.options.adapt" },
        { "value": "portrait", "label": "t:sections.recently_viewed.settings.image_ratio.options.portrait" },
        { "value": "square", "label": "t:sections.recently_viewed.settings.image_ratio.options.square" },
        { "value": "landscape", "label": "t:sections.recently_viewed.settings.image_ratio.options.landscape" }
      ],
      "default": "portrait"
    },
    {
      "type": "select",
      "id": "card_style",
      "label": "t:sections.recently_viewed.settings.card_style.label",
      "options": [
        { "value": "default", "label": "t:sections.recently_viewed.settings.card_style.options.default" },
        { "value": "minimal", "label": "t:sections.recently_viewed.settings.card_style.options.minimal" },
        { "value": "bordered", "label": "t:sections.recently_viewed.settings.card_style.options.bordered" }
      ],
      "default": "default"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "t:sections.recently_viewed.settings.show_vendor.label",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "label": "t:sections.recently_viewed.settings.show_rating.label",
      "default": true
    },
    {
      "type": "header",
      "content": "t:sections.all.padding.section_padding_heading"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "t:sections.all.padding.padding_top",
      "default": 60,
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 60,
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px"
    }
  ],
  "presets": [
    {
      "name": "t:sections.recently_viewed.name"
    }
  ]
}
{% endschema %}
