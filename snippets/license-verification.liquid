{%- comment -%}
  License Verification Snippet
  Verifies the theme license key against the Sallety API server.
  Displays a blocking modal if the license is invalid or missing.
{%- endcomment -%}

{%- liquid
  assign license_key = settings.license_key | strip
  comment
    shop.permanent_domain returns the Shopify subdomain (e.g., "mystore.myshopify.com")
    This is the store's permanent .myshopify.com domain used for license verification
  endcomment
  assign shop_url = shop.permanent_domain
  assign has_license_key = false
  if license_key != blank and license_key.size > 10
    assign has_license_key = true
  endif
-%}

<div id="sallety-license-modal" class="sallety-license-modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="license-modal-title">
  <div class="sallety-license-modal__backdrop"></div>
  <div class="sallety-license-modal__container">
    <div class="sallety-license-modal__content">
      {%- comment -%} Logo/Brand {%- endcomment -%}
      <div class="sallety-license-modal__logo">
        <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="64" height="64" rx="16" fill="#1A2744"/>
          <path d="M20 32C20 25.373 25.373 20 32 20C38.627 20 44 25.373 44 32C44 38.627 38.627 44 32 44" stroke="white" stroke-width="3" stroke-linecap="round"/>
          <path d="M32 28V36M32 36L28 32M32 36L36 32" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      
      {%- comment -%} Title {%- endcomment -%}
      <h2 id="license-modal-title" class="sallety-license-modal__title">
        {{ 'license.invalid_title' | t }}
      </h2>
      
      {%- comment -%} Message {%- endcomment -%}
      <p class="sallety-license-modal__message" id="license-modal-message">
        {{ 'license.invalid_message' | t }}
      </p>
      
      {%- comment -%} Error Details (populated by JS) {%- endcomment -%}
      <p class="sallety-license-modal__error" id="license-modal-error" style="display: none;"></p>
      
      {%- comment -%} Action Buttons {%- endcomment -%}
      <div class="sallety-license-modal__actions">
        <a href="https://sallety-theme.dev/pricing" target="_blank" rel="noopener noreferrer" class="sallety-license-modal__btn sallety-license-modal__btn--primary">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          {{ 'license.get_license' | t }}
        </a>
        <a href="https://sallety-theme.dev/support" target="_blank" rel="noopener noreferrer" class="sallety-license-modal__btn sallety-license-modal__btn--secondary">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          {{ 'license.contact_support' | t }}
        </a>
      </div>
      
      {%- comment -%} Theme Info {%- endcomment -%}
      <div class="sallety-license-modal__footer">
        <span>Sallety Theme</span>
        <span class="sallety-license-modal__separator">â€¢</span>
        <span>{{ 'license.powered_by' | t }}</span>
      </div>
    </div>
  </div>
</div>

<style>
  .sallety-license-modal {
    position: fixed;
    inset: 0;
    z-index: 999999;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--font-body-family);
  }
  
  .sallety-license-modal__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(26, 39, 68, 0.95);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }
  
  .sallety-license-modal__container {
    position: relative;
    width: 100%;
    max-width: 639px;
    margin: 1rem;
    animation: salletyModalSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }
  
  @keyframes salletyModalSlideIn {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  
  .sallety-license-modal__content {
    background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
    border-radius: var(--button-border-radius, 24px);
    padding: 2.5rem 2rem;
    text-align: center;
    box-shadow: 
      0 25px 50px -12px rgba(0, 0, 0, 0.25),
      0 0 0 1px rgba(255, 255, 255, 0.1);
  }
  
  .sallety-license-modal__logo {
    margin-bottom: 1.5rem;
    display: inline-block;
  }
  
  .sallety-license-modal__logo svg rect {
    fill: var(--button-primary-bg, #1A2744);
  }
  
  .sallety-license-modal__logo svg {
    filter: drop-shadow(0 4px 12px rgba(26, 39, 68, 0.3));
  }
  
  .sallety-license-modal__title {
    font-family: var(--font-heading-family);
    font-size: var(--font-heading-size, 1.5rem);
    font-weight: var(--font-heading-weight, 700);
    color: var(--button-primary-bg, #1A2744);
    margin: 0 0 1rem;
    line-height: 1.3;
  }
  
  .sallety-license-modal__message {
    font-family: var(--font-body-family);
    font-size: var(--font-body-size, 1rem);
    color: #4b5563;
    line-height: 1.7;
    margin: 0 0 1.5rem;
  }
  
  .sallety-license-modal__error {
    font-family: var(--font-body-family);
    font-size: calc(var(--font-body-size, 1rem) * 0.875);
    color: var(--input-error-border, #b91c1c);
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: var(--input-border-radius, 12px);
    padding: 0.875rem 1rem;
    margin: 0 0 1.5rem;
    text-align: center;
  }
  
  .sallety-license-modal__actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }
  
  .sallety-license-modal__btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: var(--button-padding-vertical, 1rem) var(--button-padding-horizontal, 1.5rem);
    border-radius: var(--button-border-radius, 12px);
    font-family: var(--font-body-family);
    font-size: var(--font-body-size, 1rem);
    font-weight: var(--button-font-weight, 600);
    text-transform: var(--button-text-transform, none);
    text-decoration: none;
    transition: all var(--button-transition-duration, 200ms) ease;
    cursor: pointer;
    border: var(--button-border-thickness, 2px) solid transparent;
  }
  
  .sallety-license-modal__btn--primary {
    background-color: var(--button-primary-bg, #1A2744);
    color: var(--button-primary-text, #ffffff);
    border-color: var(--button-primary-bg, #1A2744);
    box-shadow: var(--button-shadow-value, 0 4px 14px rgba(26, 39, 68, 0.4));
  }
  
  .sallety-license-modal__btn--primary:hover {
    background-color: var(--button-primary-bg-hover, #0f172a);
    color: var(--button-primary-text-hover, #ffffff);
    border-color: var(--button-primary-bg-hover, #0f172a);
    transform: translateY(-2px);
    box-shadow: var(--button-shadow-hover-value, 0 6px 20px rgba(26, 39, 68, 0.5));
  }
  
  .sallety-license-modal__btn--secondary {
    background-color: var(--button-secondary-bg, #f1f5f9);
    color: var(--button-secondary-text, #1A2744);
    border-color: var(--button-secondary-border, #e2e8f0);
  }
  
  .sallety-license-modal__btn--secondary:hover {
    background-color: var(--button-secondary-bg-hover, #e2e8f0);
    color: var(--button-secondary-text-hover, #1A2744);
    transform: translateY(-2px);
  }
  
  .sallety-license-modal__footer {
    font-family: var(--font-body-family);
    font-size: calc(var(--font-body-size, 1rem) * 0.8125);
    color: #94a3b8;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  
  .sallety-license-modal__separator {
    opacity: 0.5;
  }
  
  /* Mobile Responsive */
  @media (max-width: 639px) {
    .sallety-license-modal__content {
      padding: 2rem 1.5rem;
      border-radius: calc(var(--button-border-radius, 24px) * 0.833);
    }
  }
</style>

<script>
(function() {
  'use strict';
  
  const SALLETY_CONFIG = {
    apiUrl: 'https://api.sallety-theme.dev/api/license/verify-shopify',
    licenseKey: {{ license_key | json }},
    shopUrl: {{ shop_url | json }},
    hasLicenseKey: {{ has_license_key | json }},
    cacheKey: 'sallety_license_status',
    cacheDuration: 1000 * 60 * 30, // 30 minutes
    debug: true, // Enable debug logging
  };
  
  const LicenseVerifier = {
    modal: null,
    errorEl: null,
    
    log(...args) {
      if (SALLETY_CONFIG.debug) {
        console.log('[Sallety License]', ...args);
      }
    },
    
    init() {
      this.modal = document.getElementById('sallety-license-modal');
      this.errorEl = document.getElementById('license-modal-error');
      
      if (!this.modal) return;
      
      this.log('Config:', {
        apiUrl: SALLETY_CONFIG.apiUrl,
        licenseKey: SALLETY_CONFIG.licenseKey ? SALLETY_CONFIG.licenseKey.substring(0, 20) + '...' : 'NOT SET',
        shopUrl: SALLETY_CONFIG.shopUrl,
        hasLicenseKey: SALLETY_CONFIG.hasLicenseKey,
      });
      
      // Check if we have a cached valid result
      if (this.checkCache()) {
        this.log('Using cached valid license');
        return; // License is valid, no need to verify again
      }
      
      // If no license key provided, show modal immediately
      if (!SALLETY_CONFIG.hasLicenseKey) {
        this.log('No license key found');
        this.showModal({{ 'license.no_key_message' | t | json }});
        return;
      }
      
      // Verify with server
      this.verifyLicense();
    },
    
    checkCache() {
      try {
        const cached = sessionStorage.getItem(SALLETY_CONFIG.cacheKey);
        if (!cached) return false;
        
        const data = JSON.parse(cached);
        const now = Date.now();
        
        // Check if cache is still valid and license was valid
        if (data.valid && data.timestamp && (now - data.timestamp) < SALLETY_CONFIG.cacheDuration) {
          return true;
        }
        
        // Clear expired cache
        sessionStorage.removeItem(SALLETY_CONFIG.cacheKey);
        return false;
      } catch (e) {
        return false;
      }
    },
    
    setCache(valid) {
      try {
        sessionStorage.setItem(SALLETY_CONFIG.cacheKey, JSON.stringify({
          valid: valid,
          timestamp: Date.now(),
        }));
      } catch (e) {
        // Silently fail if sessionStorage is not available
      }
    },
    
    async verifyLicense() {
      this.log('Verifying license...');
      this.log('Sending request to:', SALLETY_CONFIG.apiUrl);
      this.log('Request body:', {
        licenseKey: SALLETY_CONFIG.licenseKey,
        shopifyUrl: SALLETY_CONFIG.shopUrl,
      });
      
      try {
        const response = await fetch(SALLETY_CONFIG.apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          },
          body: JSON.stringify({
            licenseKey: SALLETY_CONFIG.licenseKey,
            shopifyUrl: SALLETY_CONFIG.shopUrl,
          }),
        });
        
        this.log('Response status:', response.status);
        
        const result = await response.json();
        this.log('Response body:', result);
        
        if (result.success && result.data && result.data.valid) {
          // License is valid - cache and continue
          this.log('License is VALID');
          this.setCache(true);
          return;
        }
        
        // License is invalid - show modal
        this.log('License is INVALID:', result.data?.reason || result.message);
        this.setCache(false);
        const errorMessage = result.data?.message || result.message || {{ 'license.verification_failed' | t | json }};
        this.showModal(errorMessage);
        
      } catch (error) {
        console.error('Sallety License Verification Error:', error);
        this.log('Network/CORS Error:', error.message);
        // On network error, show modal with connection error message
        this.showModal({{ 'license.network_error' | t | json }});
      }
    },
    
    showModal(errorMessage) {
      if (!this.modal) return;
      
      // Show error details if provided
      if (errorMessage && this.errorEl) {
        this.errorEl.textContent = errorMessage;
        this.errorEl.style.display = 'block';
      }
      
      // Show the modal
      this.modal.style.display = 'flex';
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
      
      // Trap focus in modal
      this.trapFocus();
    },
    
    trapFocus() {
      const focusableElements = this.modal.querySelectorAll('a[href], button');
      if (focusableElements.length === 0) return;
      
      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];
      
      firstElement.focus();
      
      this.modal.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
          if (e.shiftKey) {
            if (document.activeElement === firstElement) {
              e.preventDefault();
              lastElement.focus();
            }
          } else {
            if (document.activeElement === lastElement) {
              e.preventDefault();
              firstElement.focus();
            }
          }
        }
      });
    },
  };
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => LicenseVerifier.init());
  } else {
    LicenseVerifier.init();
  }
})();
</script>
