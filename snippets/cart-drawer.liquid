{%- comment -%}
  Sallety Theme - Cart Drawer Snippet
  Renders a premium slide-out cart drawer with RTL support.

  Usage:
  {% render 'cart-drawer' %}
{%- endcomment -%}

<!-- Cart Drawer Overlay -->
<div
  class="cart-drawer-overlay fixed inset-0 z-[999] bg-foreground/60 backdrop-blur-sm opacity-0 invisible transition-all duration-300 ease-out"
  data-drawer-overlay
></div>

<!-- Cart Drawer -->
{%- capture section_dir -%}{%- render 'section-dir' -%}{%- endcapture -%}
<div
  class="cart-drawer drawer fixed top-0 bottom-0 z-[1000] w-full max-w-[420px] bg-background shadow-2xl flex flex-col"
  id="cart-drawer"
  dir="{{ section_dir }}"
  role="dialog"
  aria-modal="true"
  aria-label="{{ 'cart.general.title' | t }}"
>
  <!-- Drawer Header -->
  <div class="flex-shrink-0 flex items-center justify-between px-5 py-4 border-b border-border bg-background">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
      </div>
      <div>
        <h2 class="text-lg font-semibold text-foreground">{{ 'cart.general.title' | t }}</h2>
        <p class="text-xs text-secondary" data-cart-count-text>
          {{ 'cart.general.item_count' | t: count: cart.item_count }}
        </p>
      </div>
    </div>
    <button
      type="button"
      class="w-10 h-10 flex items-center justify-center rounded-full bg-border/30 hover:bg-border text-secondary hover:text-foreground transition-all duration-200"
      data-drawer-close
      aria-label="{{ 'accessibility.close' | t }}"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>

  <!-- Drawer Content -->
  <div class="flex-1 overflow-y-auto overscroll-contain" data-cart-drawer-content>
    {%- if cart.item_count > 0 -%}
      <!-- Free Shipping Bar -->
      {%- if settings.show_free_shipping_bar -%}
        <div class="px-5 py-4 bg-gradient-to-r from-primary/5 to-accent/5 border-b border-border">
          {% render 'free-shipping-bar-premium' %}
        </div>
      {%- endif -%}

      <!-- Cart Items -->
      <div class="divide-y divide-border">
        {%- for item in cart.items -%}
          {% render 'cart-item-premium', item: item, line_index: forloop.index %}
        {%- endfor -%}
      </div>

      <!-- Upsell Section (Optional) -->
      {%- if settings.cart_upsell_enabled and recommendations.products.size > 0 -%}
        <div class="px-5 py-4 bg-border/20">
          <h3 class="text-sm font-semibold text-foreground mb-3">
            {{ 'cart.general.you_may_also_like' | t | default: 'قد يعجبك أيضاً' }}
          </h3>
          <div class="flex gap-3 overflow-x-auto pb-2 -mx-1 px-1 snap-x snap-mandatory">
            {%- for product in recommendations.products limit: 4 -%}
              <a href="{{ product.url }}" class="flex-shrink-0 w-24 snap-start group">
                <div class="aspect-square rounded-lg overflow-hidden bg-border/30 mb-2">
                  <img
                    src="{{ product.featured_image | image_url: width: 200 }}"
                    alt="{{ product.title | escape }}"
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                    loading="lazy"
                  >
                </div>
                <p class="text-xs font-medium text-foreground line-clamp-2">{{ product.title }}</p>
                <p class="text-xs text-primary font-semibold">{{ product.price | money }}</p>
              </a>
            {%- endfor -%}
          </div>
        </div>
      {%- endif -%}

    {%- else -%}
      <!-- Empty State -->
      <div class="flex flex-col items-center justify-center h-full px-5 py-12 text-center">
        <div class="w-24 h-24 rounded-full bg-border/30 flex items-center justify-center mb-6">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="48"
            height="48"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="text-secondary"
          >
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-foreground mb-2">{{ 'cart.general.empty' | t }}</h3>
        <p class="text-sm text-secondary mb-6 max-w-[250px]">
          {{ 'cart.general.empty_description' | t | default: 'لم تقم بإضافة أي منتجات إلى سلة التسوق بعد' }}
        </p>
        <a
          href="{{ routes.all_products_collection_url }}"
          class="inline-flex items-center gap-2 px-6 py-3 rounded-full bg-primary text-white font-medium hover:bg-primary/90 transition-all duration-200 shadow-lg shadow-primary/25"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <path d="M16 10a4 4 0 0 1-8 0"></path>
          </svg>
          {{ 'cart.general.continue_shopping' | t }}
        </a>
      </div>
    {%- endif -%}
  </div>

  <!-- Drawer Footer -->
  {%- if cart.item_count > 0 -%}
    <div class="flex-shrink-0 border-t border-border bg-background">
      <!-- Cart Notes (Collapsible) -->
      <details class="group border-b border-border">
        <summary class="flex items-center justify-between px-5 py-3 cursor-pointer hover:bg-border/20 transition-colors">
          <span class="text-sm font-medium text-foreground flex items-center gap-2">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            {{ 'cart.general.note' | t | default: 'ملاحظات الطلب' }}
          </span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="text-secondary group-open:rotate-180 transition-transform duration-200"
          >
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </summary>
        <div class="px-5 pb-4">
          <textarea
            name="note"
            class="w-full h-20 px-3 py-2 text-sm border border-border rounded-lg bg-background text-foreground placeholder:text-secondary/60 focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary resize-none transition-all"
            placeholder="{{ 'cart.general.note_placeholder' | t | default: 'أضف ملاحظات خاصة بطلبك...' }}"
            data-cart-note
          >{{ cart.note }}</textarea>
        </div>
      </details>

      <!-- Subtotal & Actions -->
      <div class="px-5 py-4 space-y-4">
        <!-- Subtotal -->
        <div class="space-y-2">
          <div class="flex items-center justify-between">
            <span class="text-sm text-secondary">{{ 'cart.general.subtotal' | t }}</span>
            <span class="text-lg font-bold text-foreground" data-cart-total>{{ cart.total_price | money }}</span>
          </div>
          {%- if cart.total_discount > 0 -%}
            <div class="flex items-center justify-between text-success">
              <span class="text-sm">{{ 'cart.general.savings' | t | default: 'التوفير' }}</span>
              <span class="text-sm font-medium">-{{ cart.total_discount | money }}</span>
            </div>
          {%- endif -%}
          <p class="text-xs text-secondary">
            {{ 'cart.general.taxes_and_shipping_policy_at_checkout_html' | t }}
          </p>
        </div>

        <!-- Action Buttons -->
        <div class="space-y-2">
          <a
            href="/checkout"
            class="flex items-center justify-center gap-2 w-full py-3.5 px-6 rounded-xl bg-primary text-white font-semibold hover:bg-primary/90 transition-all duration-200 shadow-lg shadow-primary/25"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
              <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
            {{ 'cart.general.checkout' | t }}
          </a>
          <a
            href="{{ routes.cart_url }}"
            class="flex items-center justify-center gap-2 w-full py-3 px-6 rounded-xl border-2 border-border text-foreground font-medium hover:bg-border/30 transition-all duration-200"
          >
            {{ 'cart.general.view_cart' | t | default: 'عرض السلة' }}
          </a>
        </div>

        <!-- Trust Badges -->
        <div class="flex items-center justify-center gap-4 pt-2">
          <div class="flex items-center gap-1.5 text-secondary">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            <span class="text-xs">{{ 'cart.general.secure' | t | default: 'دفع آمن' }}</span>
          </div>
          <div class="flex items-center gap-1.5 text-secondary">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            <span class="text-xs">{{ 'cart.general.shipping' | t | default: 'شحن سريع' }}</span>
          </div>
          <div class="flex items-center gap-1.5 text-secondary">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            <span class="text-xs">{{ 'cart.general.guarantee' | t | default: 'ضمان الجودة' }}</span>
          </div>
        </div>
      </div>
    </div>
  {%- endif -%}
</div>

<style>
  /* Cart Drawer - Always slides from physical right side */
  .cart-drawer {
    right: -100%;
    left: auto;
    inset-inline-end: auto;
    inset-inline-start: auto;
    transition: right 0.35s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.35s;
    box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
  }

  .cart-drawer.is-open {
    right: 0;
    inset-inline-end: auto;
    visibility: visible;
  }

  .cart-drawer-overlay.is-open {
    opacity: 1;
    visibility: visible;
  }

  /* Scrollbar Styling */
  .cart-drawer [data-cart-drawer-content]::-webkit-scrollbar {
    width: 4px;
  }

  .cart-drawer [data-cart-drawer-content]::-webkit-scrollbar-track {
    background: transparent;
  }

  .cart-drawer [data-cart-drawer-content]::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 2px;
  }

  .cart-drawer [data-cart-drawer-content]::-webkit-scrollbar-thumb:hover {
    background: var(--color-secondary);
  }

  /* Line clamp utility */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Snap scroll for upsell */
  .snap-x {
    scroll-snap-type: x mandatory;
  }

  .snap-start {
    scroll-snap-align: start;
  }

  .snap-mandatory {
    scroll-snap-type: x mandatory;
  }
</style>

<script>
  // Cart Drawer Close Functionality
  (function () {
    var cartDrawer = document.getElementById('cart-drawer');
    var cartOverlay = document.querySelector('.cart-drawer-overlay');
    var closeBtn = cartDrawer ? cartDrawer.querySelector('[data-drawer-close]') : null;

    function closeCartDrawer() {
      if (cartDrawer) {
        cartDrawer.classList.remove('is-open');
        cartDrawer.setAttribute('aria-hidden', 'true');
      }
      if (cartOverlay) {
        cartOverlay.classList.remove('is-open');
      }
      document.body.style.overflow = '';
    }

    // Close button click
    if (closeBtn) {
      closeBtn.addEventListener('click', function (e) {
        e.preventDefault();
        closeCartDrawer();
      });
    }

    // Overlay click
    if (cartOverlay) {
      cartOverlay.addEventListener('click', function (e) {
        e.preventDefault();
        closeCartDrawer();
      });
    }

    // Escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && cartDrawer && cartDrawer.classList.contains('is-open')) {
        closeCartDrawer();
      }
    });
  })();
</script>
